#%%
import sys, os
sys.path.append(os.path.dirname(os.getcwd()))  
from tools.tools import *
import pandas as pd
import datetime

main_db_file = 'data/financial_reports_main.feather'
main_db = pd.read_feather(main_db_file)
all_codes = main_db['code'].unique()

update_db_file = 'data/financial_reports_update.feather'
update_db = pd.read_feather(update_db_file)
codes = update_db['code'].unique()
#%%
except_list = ['091990', '005070', '403870', '001740', '009240', '185750', '225570', '336570', '085370', '294090', '215200', '182400', '011810', '082270', '077500', '074610', '348340', '015540', '183190', '363280', '084110', '334970', '093640', '048530', '045100', '083930', '003960', '229640', '102260', '419050', '091580', '250060', '173130', '321550', '002620', '419080', '078940', '261200', '006490', '061250', '002700', '046140', '060310', '082660', '017040', '377220', '003780', '333430', '109860', '008830', '004060', '173940', '201490', '263800', '351330', '124500', '339950', '222420', '323280', '025750', '032680', '006980', '052900', '069110', '139670', '009770', '033200', '002410', '089140', '204840', '204630', '217620', '187660', '155900', '148250', '353190', '065060', '424760', '072950', '154030', '237750', '331920', '241820', '161570', '054180', '106240', '069330', '071460', '377460', '069140', '014200', '367360', '006580', '450410', '000400', '068060', '099520', '096640', '056000', '083660', '181340', '000110', '005980', '010050', '048260', '012580', '038160', '002550', '005270', '057500', '039230', '052670', '062860', '046070', '160600', '065560', '103160', '150840', '089530', '174880', '053660', '121800', '078650', '194510', '138690', '033340', '102210', '101000', '257370', '036220', '268600', '219750', '114120', '031990', '017680', '318020', '011160', '047820', '064090', '126870', '263540', '044060', '269620', '078130', '136510', '032860', '068420', '217480', '068940', '056090', '066410', '141020', '148140', '081970', '060910', '033630', '060300', '090120', '049130', '010090', '158310', '051310', '021960', '192520', '050540', '024810', '086250', '155960', '032040', '033430', '046400', '001890', '035430', '011400', '066110', '065160', '053110', '008800', '226350', '058530', '178780', '101970', '057880', '037340', '000800', '054340', '094190', '052190', '005450', '064510', '047730', '046110', '112240', '008270', '377630', '373340', '090740', '050320', '380440', '290380', '037640', '039790', '039670', '134780', '067250', '404950', '052270', '111820', '139200', '377400', '008120', '298870', '111870', '000060', '070080']

#%%
l = len(all_codes)
log_file = 'dc_06_exception_errors.txt'
for i, code in enumerate(all_codes[:]): 
    try:
        if code in except_list:
            continue
        print('-------------------')
        print('{} | {}/{}'.format(code, i, l))
        path = 'plots/'+code+'.png'
        plot_company_financial_summary(main_db, code, path)
        print(datetime.datetime.now())
    except Exception as error:
        except_list.append(code)
        log_print(log_file, code+' | '+str(error))

log_print(log_file, 'Exception list: '+ str(except_list))
    

#### To-do next #### 
# - generate images for all codes (check if any errors occur while generating images)
# - copy them to TNP server
# - make a overarching code to run dc_05 and dc_06
#     . may need to monitor the success of each code and display it to TNP webpage/dashboard
# - copy newly generated images to TNP server for update/replace
